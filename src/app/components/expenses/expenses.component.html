<div class="expenses-container">
  <!-- User Greeting -->
  <div class="user-greeting">
    <h1>Hello, {{ getPrimaryUserName() }}</h1>
  </div>

  <!-- Balance Summary -->
  <div class="balance-card">
    <h2>Balance Overview</h2>
    <div class="balance-details">
      <div class="balance-item">
        <span class="user-name">{{ users[0]?.name || 'User 1' }}</span>
        <span class="owes-amount">owes: €{{ balance.user1Owes.toFixed(2) }}</span>
        <span class="paid-amount">Paid: €{{ balance.user1Paid.toFixed(2) }}</span>
      </div>
      <div class="balance-item">
        <span class="user-name">{{ users[1]?.name || 'User 2' }}</span>
        <span class="owes-amount">owes: €{{ balance.user2Owes.toFixed(2) }}</span>
        <span class="paid-amount">Paid: €{{ balance.user2Paid.toFixed(2) }}</span>
      </div>
      <div class="net-balance" 
           [class.positive]="isPrimaryUserOwed()" 
           [class.negative]="isPrimaryUserOwing()">
        <strong>{{ getNetBalanceText() }}</strong>
      </div>
    </div>
  </div>


  <!-- Controls -->
  <div class="controls">
    <button class="add-btn" (click)="toggleForm()">
      {{ showForm ? 'Cancel' : 'Add Expense' }}
    </button>
    
    <div class="hot-buttons" *ngIf="!showForm">
      <button class="hot-btn" (click)="usePreset('hofer')">Hofer/Spar</button>
      <button class="hot-btn" (click)="usePreset('apotheke')">Apotheke</button>
      <button class="hot-btn" (click)="usePreset('bipa')">Bipa/Dm</button>
    </div>
    
    <div class="filter-section">
      <label>Filter:</label>
      <select [(ngModel)]="selectedCategory" (change)="onCategoryChange()" class="category-filter">
        <option value="all">All Categories</option>
        <option *ngFor="let category of categories" [value]="category.id">
          {{ category.name | titlecase }}
        </option>
      </select>
    </div>
  </div>

  <!-- Add Expense Form -->
  <div class="expense-form" *ngIf="showForm">
    <h3>Add New Expense</h3>
    <form (ngSubmit)="addExpense()" #expenseForm="ngForm">
      <div class="form-row">
        <div class="form-group">
          <label>Who paid?</label>
          <select [(ngModel)]="newExpense.user_id" name="user_id" required>
            <option *ngFor="let user of users" [value]="user.id">{{ user.name }}</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Amount (€)</label>
          <input type="number" [(ngModel)]="newExpense.amount" name="amount" min="0" step="0.01" required placeholder="0" class="amount-input" [class.placeholder-visible]="newExpense.amount === 0" (focus)="onAmountFocus()" (blur)="onAmountBlur()">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Category</label>
          <select [(ngModel)]="newExpense.category_id" name="category_id" required>
            <option *ngFor="let category of categories" [value]="category.id">
              {{ category.name | titlecase }}
            </option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Split Type</label>
          <select [(ngModel)]="newExpense.split_type" name="split_type" required>
            <option value="50-50">50/50 Split</option>
            <option value="100-other">100% for Other Person</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Date</label>
          <input type="date" [(ngModel)]="newExpense.created_at" name="created_at" required>
        </div>
        
        <div class="form-group">
          <label>Description</label>
          <input type="text" [(ngModel)]="newExpense.description" name="description" placeholder="What was this for?">
        </div>
      </div>

      <button type="submit" [disabled]="!expenseForm.valid" class="submit-btn">
        Add Expense
      </button>
    </form>
  </div>

  <!-- Expenses List -->
  <div class="expenses-list">
    <h3>Recent Transactions ({{ filteredExpenses.length }})</h3>
    
    <div *ngIf="filteredExpenses.length === 0" class="no-expenses">
      No expenses found. Add your first expense above!
    </div>

    <!-- Group expenses by month -->
    <ng-container *ngFor="let monthGroup of getExpensesByMonth()">
      <!-- Month Divider -->
      <div class="month-divider">
        <h4 class="month-header">{{ monthGroup.monthYear }}</h4>
        <span class="month-total">{{ monthGroup.expenses.length }} transaction{{ monthGroup.expenses.length !== 1 ? 's' : '' }}</span>
      </div>

      <!-- Expenses for this month -->
      <div class="expense-item" 
           *ngFor="let expense of monthGroup.expenses" 
           [class.paid-expense]="expense.paid"
           [style.--category-color]="getCategoryColor(expense.category?.name)">
        <div class="expense-content">
          <div class="expense-main">
            <div class="category-icon-small" 
                 [style.background-color]="getCategoryColor(expense.category?.name)">
              {{ getCategoryIcon(expense.category?.name) }}
            </div>
            <div class="expense-details">
              <div class="expense-primary-line">
                <div class="expense-description">{{ expense.description || 'No description' }}</div>
                <div class="expense-amount-main" [ngClass]="getAmountColorClass(expense)">
                  {{ getDisplayAmountWithSign(expense) }}
                </div>
              </div>
              <div class="expense-meta">
                <span class="expense-user-tag">{{ expense.user?.name }}</span>
                <span class="expense-category-tag">{{ expense.category?.name | titlecase }}</span>
                <span class="expense-date">{{ expense.created_at | date:'MMM dd' }}</span>
              </div>
            </div>
          </div>
          <div class="expense-actions">
            <button (click)="togglePaid(expense)" 
                    class="toggle-paid-btn" 
                    [class.paid]="expense.paid">
              {{ expense.paid ? 'Paid' : 'Mark Paid' }}
            </button>
            <button (click)="deleteExpense(expense.id)" class="delete-btn">×</button>
          </div>
        </div>
      </div>
    </ng-container>
  </div>
</div>


